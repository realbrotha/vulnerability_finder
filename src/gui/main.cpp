#include <nana/gui.hpp>
#include <nana/gui/widgets/listbox.hpp>
#include <nana/gui/widgets/button.hpp>
#include <nana/gui/widgets/label.hpp>
#include <nana/gui/place.hpp>
/** Change listbox cell colors without changing text
    @param[in] lb the listbox containing the cell
    @param[in] cat the category containing the cell, zero-based index
    @param[in] row the "item" containing the cell, zero-based index
    @param[in] col the column containing the cell, zero-based index
    @param[in] new_fgcolor foreground color
    @param[in] new_bgcolor background color
*/
#include "../nunu/AbsoluteZero.h"
#include <stdlib.h>
#include <stdio.h>

nana::listbox *p_lb;
int listbox_count = 0;
void change_cell_colors(
    nana::listbox& lb,
    int cat,
    int row,
    int col,
    nana::colors new_fgcolor,
    nana::colors new_bgcolor
)
{
  auto item_proxy = lb.at(nana::listbox::index_pair(cat,row));
  nana::listbox::cell cell( {item_proxy.text(col),{new_bgcolor,new_fgcolor}} );
  item_proxy.text(col,cell);
}

void PreScan(struct RULES rule) {
  printf ("[%s] %s\n",  rule.tags.c_str(), rule.descrption.c_str());
  return;
}
void SuccesScan(struct RULES rule) {
  p_lb->at(0).append({ rule.tags.c_str(), rule.descrption.c_str(), "(정상) 검사결과 이상 없습니다."});

  p_lb->auto_draw( false );

  change_cell_colors(
      *p_lb, 0, listbox_count++, 2,
      nana::colors::white,
      nana::colors::blue );

  p_lb->auto_draw( true );
  return;
}
void FailedScan(struct RULES rule) {
  p_lb->at(0).append({ rule.tags.c_str(), rule.descrption.c_str(), rule.failed_message.c_str()});
  change_cell_colors(
      *p_lb, 0, listbox_count++, 2,
      nana::colors::white,
      nana::colors::red );
  return;
}



int main()
{
  std::string test = "test.txt";
  AbsoluteZero az;
  az.Initialize(test);
  az.SetCallback(PreScan, SuccesScan, FailedScan);
  printf ("************************ 검사를 시작합니다. ************************\n");

  nana::form fm( nana::rectangle( 500,500, 1000, 600 ));

  fm.caption("MPI for Linux proto type");

  nana::button btn(fm, nana::rectangle(20, 100, 140, 40));
  btn.caption("Scan Start");
  btn.events().click([&]{
    az.Start();
    // This line above seems to be the problem
  });

  nana::listbox lb(fm, nana::rectangle(200, 100, 780, 320));
  p_lb = &lb;
  lb.append_header("id",50);
  lb.append_header("검사 항목",400);
  lb.append_header("결과 ",300);

  // show & run
  fm.show();

  nana::paint::image img("bg.bmp");
  nana::drawing dw(fm);
  dw.draw([&img](nana::paint::graphics & graph)
          {
            if (img.empty()) return;
            img.paste(graph, nana::point{} );
          });
  dw.update();

  nana::exec();

}